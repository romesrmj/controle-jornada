<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Jornada - Multiusu치rio com Admin</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4;}
h1,h2,h3,h4{text-align:center;margin:10px 0;}
.form-container{max-width:500px;margin:20px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
input,select,button{width:100%;padding:10px;margin:8px 0;font-size:16px;box-sizing:border-box;}
button{background:#4CAF50;color:white;border:none;cursor:pointer;}
button:hover{background:#45a049;}
table{width:100%;border-collapse:collapse;margin-bottom:20px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px;}
th{background:#f2f2f2;}
#sistema{display:none;}
#logout{float:right;margin-right:20px;cursor:pointer;color:#f00;font-weight:bold;}
.fechado{background-color:#e0ffe0;}
@media(max-width:600px){
    th,td{font-size:12px;padding:6px;}
    input,select,button{font-size:14px;padding:8px;}
}
</style>
</head>
<body>

<h1>Controle de Jornada</h1>

<!-- LOGIN -->
<div id="login">
    <div class="form-container">
        <h2>Login</h2>
        <input type="text" id="usuario" placeholder="Usu치rio">
        <input type="password" id="senha" placeholder="Senha">
        <button onclick="tentarLogin()">Entrar</button>
    </div>
</div>

<!-- SISTEMA -->
<div id="sistema">
    <span id="logout" onclick="logout()">Sair</span>
    <h2>Bem-vindo, <span id="nomeUsuario"></span></h2>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="form-container" style="display:none;">
        <h3>Admin - Gerenciar Usu치rios</h3>
        <input type="text" id="novoUsuario" placeholder="Novo usu치rio">
        <input type="password" id="novaSenha" placeholder="Senha do novo usu치rio">
        <button onclick="criarUsuario()">Criar Usu치rio</button>
        <h4>Lista de Usu치rios</h4>
        <ul id="listaUsuarios" style="list-style:none;padding:0;"></ul>
    </div>

    <!-- REGISTRO DE PONTO -->
    <div class="form-container">
        <label>Data do Registro:</label>
        <input type="date" id="data">
        <label>Entrada:</label>
        <input type="time" id="entrada">
        <label>Almo칞o:</label>
        <input type="time" id="almoco">
        <label>Retorno:</label>
        <input type="time" id="retorno">
        <button onclick="registrar()">Registrar</button>
    </div>

    <!-- REGISTROS ABERTOS -->
    <div class="form-container">
        <h2>Registros Abertos</h2>
        <table>
            <thead>
                <tr>
                    <th>Dia</th><th>Entrada</th><th>Almo칞o</th><th>Retorno</th><th>Sa칤da Estimada</th><th>Sa칤da Real</th><th>Banco</th><th>A칞칚o</th>
                </tr>
            </thead>
            <tbody id="abertos"></tbody>
        </table>
    </div>

    <!-- HIST칍RICO -->
    <div class="form-container">
        <h2>Hist칩rico</h2>
        <div id="historico"></div>
    </div>
</div>

<script>
/* ---------- CONFIGURA칂츾O ---------- */
const JORNADA = 8*60+48; // 8h48

/* ---------- FUN칂츾O DE HASH (SHA-256) ---------- */
async function hashSenha(senha){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest("SHA-256", enc.encode(senha));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ---------- USU츼RIOS INICIAIS ---------- */
(async function initUsuarios(){
    if(!localStorage.getItem("usuarios")){
        const usuarios=[
            {usuario:"admin",senha:await hashSenha("91297686")},
            {usuario:"romes",senha:await hashSenha("91297686")},
            {usuario:"eduardosantana",senha:await hashSenha("ED123456")},
        ];
        localStorage.setItem("usuarios",JSON.stringify(usuarios));
    }
})();

/* ---------- LOGIN ---------- */
async function tentarLogin(){
    const usuarioInput=document.getElementById("usuario").value.trim().toLowerCase();
    const senha=document.getElementById("senha").value;
    if(!usuarioInput||!senha){alert("Preencha os campos"); return;}
    const hash=await hashSenha(senha);
    const usuarios=JSON.parse(localStorage.getItem("usuarios"))||[];
    const valido=usuarios.find(u=>u.usuario.toLowerCase()===usuarioInput && u.senha===hash);

    if(!valido){
        // Reset de admin para teste
        if(usuarioInput==="admin"){
            localStorage.removeItem("usuarios");
            alert("Usu치rio admin resetado. Recarregue a p치gina e use senha padr칚o: 91297686");
            location.reload();
            return;
        } else {
            alert("Usu치rio ou senha inv치lidos");
            return;
        }
    }

    localStorage.setItem("usuarioLogado",valido.usuario);
    mostrarSistema();
}

function logout(){
    localStorage.removeItem("usuarioLogado");
    location.reload();
}

function getUsuarioLogado(){return localStorage.getItem("usuarioLogado");}

function mostrarSistema(){
    document.getElementById("login").style.display="none";
    document.getElementById("sistema").style.display="block";
    document.getElementById("nomeUsuario").innerText=getUsuarioLogado();
    if(getUsuarioLogado().toLowerCase()==="admin"){
        document.getElementById("adminPanel").style.display="block";
        carregarUsuarios();
    }
    carregarTudo();
}

/* ---------- ADMIN: GERENCIAR USU츼RIOS ---------- */
async function criarUsuario(){
    const novo=document.getElementById("novoUsuario").value.trim().toLowerCase();
    const senha=document.getElementById("novaSenha").value;
    if(!novo || !senha){alert("Preencha os campos"); return;}
    let usuarios=JSON.parse(localStorage.getItem("usuarios"))||[];
    if(usuarios.find(u=>u.usuario.toLowerCase()===novo)){alert("Usu치rio j치 existe"); return;}
    usuarios.push({usuario:novo,senha:await hashSenha(senha)});
    localStorage.setItem("usuarios",JSON.stringify(usuarios));
    document.getElementById("novoUsuario").value="";
    document.getElementById("novaSenha").value="";
    carregarUsuarios();
}

function carregarUsuarios(){
    const usuarios=JSON.parse(localStorage.getItem("usuarios"))||[];
    const lista=document.getElementById("listaUsuarios");
    lista.innerHTML="";
    usuarios.forEach(u=>{
        if(u.usuario.toLowerCase()==="admin") return;
        const li=document.createElement("li");
        li.innerHTML=`${u.usuario} <button onclick="resetSenhaPrompt('${u.usuario}')">Redefinir senha</button>`;
        lista.appendChild(li);
    });
}

async function resetSenhaPrompt(usuario){
    const nova=prompt(`Nova senha para ${usuario}:`);
    if(!nova) return;
    let usuarios=JSON.parse(localStorage.getItem("usuarios"))||[];
    const u=usuarios.find(u=>u.usuario===usuario);
    u.senha=await hashSenha(nova);
    localStorage.setItem("usuarios",JSON.stringify(usuarios));
    alert("Senha redefinida com sucesso!");
}

/* ---------- REGISTROS ---------- */
function getRegistros(){ 
    const user=getUsuarioLogado();
    return JSON.parse(localStorage.getItem(`jornada_${user}`))||[];
}

function salvar(dados){
    const user=getUsuarioLogado();
    localStorage.setItem(`jornada_${user}`,JSON.stringify(dados));
}

function emMin(hora){const [h,m]=hora.split(":").map(Number); return h*60+m;}
function emHora(minutos){const h=Math.floor(minutos/60); const m=minutos%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
function formatar(valor){const sinal=valor>=0?"+":"-"; const v=Math.abs(valor); const h=Math.floor(v/60); const m=v%60; return `${sinal}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}

function registrar(){
    const data=document.getElementById("data").value;
    const entrada=document.getElementById("entrada").value;
    const almoco=document.getElementById("almoco").value;
    const retorno=document.getElementById("retorno").value;
    if(!data||!entrada||!almoco||!retorno){alert("Preencha todos os campos"); return;}
    const registros=getRegistros();
    const saidaEstimada=emHora(emMin(entrada)+JORNADA+(emMin(retorno)-emMin(almoco)));
    registros.push({
        dia:data.split("-")[2],
        mes:parseInt(data.split("-")[1]),
        ano:parseInt(data.split("-")[0]),
        data,entrada,almoco,retorno,
        saidaEstimada,saidaReal:null,
        banco:0,status:"aberto"
    });
    salvar(registros);
    carregarTudo();
}

function fecharRegistro(index){
    const registros=getRegistros();
    const real=prompt("Informe a hora de sa칤da real (HH:MM):");
    if(!real) return;
    registros[index].saidaReal=real;
    const entradaMin=emMin(registros[index].entrada);
    const almocoMin=emMin(registros[index].almoco);
    const retornoMin=emMin(registros[index].retorno);
    const saidaMin=emMin(real);
    registros[index].banco=saidaMin-entradaMin-(retornoMin-almocoMin)-JORNADA;
    registros[index].status="fechado";
    salvar(registros);
    carregarTudo();
}

function carregarAbertos(){
    const registros=getRegistros().filter(r=>r.status==="aberto");
    const tbody=document.getElementById("abertos");
    tbody.innerHTML="";
    registros.forEach((r,i)=>{
        const tr=tbody.insertRow();
        tr.insertCell(0).innerText=r.dia;
        tr.insertCell(1).innerText=r.entrada;
        tr.insertCell(2).innerText=r.almoco;
        tr.insertCell(3).innerText=r.retorno;
        tr.insertCell(4).innerText=r.saidaEstimada;
        tr.insertCell(5).innerText=r.saidaReal||"-";
        tr.insertCell(6).innerText=formatar(r.banco);
        const btn=document.createElement("button");
        btn.innerText="Fechar";
        btn.onclick=()=>fecharRegistro(i);
        tr.insertCell(7).appendChild(btn);
    });
}

function nomeMes(mes){const meses=["Janeiro","Fevereiro","Mar칞o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]; return meses[mes-1];}

function carregarHistorico(){
    const container=document.getElementById("historico");
    container.innerHTML="";
    const registros=getRegistros().filter(r=>r.status==="fechado");
    if(registros.length===0){container.innerHTML="<p>Nenhum registro fechado.</p>";return;}
    const grupos={};
    registros.forEach(r=>{
        const chave=`${r.mes}-${r.ano}`;
        if(!grupos[chave]) grupos[chave]=[];
        grupos[chave].push(r);
    });
    const chavesOrdenadas=Object.keys(grupos).sort((a,b)=>{
        const [ma,aa]=a.split("-").map(Number);
        const [mb,ab]=b.split("-").map(Number);
        return aa!==ab?aa-ab:ma-mb;
    });
    chavesOrdenadas.forEach(chave=>{
        const [mes,ano]=chave.split("-");
        const registrosMes=grupos[chave];
        let saldoMes=0;
        let html=`<h3>游늷 ${nomeMes(mes)} / ${ano}</h3>
                  <table>
                  <thead><tr>
                    <th>Dia</th><th>Entrada</th><th>Sa칤da Estimada</th><th>Sa칤da Real</th><th>Banco</th>
                  </tr></thead><tbody>`;
        registrosMes.forEach(r=>{
            saldoMes+=r.banco;
            html+=`<tr class="fechado">
                    <td>${r.dia}</td><td>${r.entrada}</td><td>${r.saidaEstimada}</td><td>${r.saidaReal}</td><td>${formatar(r.banco)}</td>
                   </tr>`;
        });
        html+=`</tbody></table><strong>Saldo do m칡s: ${formatar(saldoMes)}</strong><hr>`;
        container.innerHTML+=html;
    });
}

function carregarTudo(){
    carregarAbertos();
    carregarHistorico();
}

/* ---------- INICIALIZA칂츾O ---------- */
document.addEventListener("DOMContentLoaded",()=>{
    if(!getUsuarioLogado()) document.getElementById("login").style.display="block";
    else mostrarSistema();
});
</script>
</body>
</html>
